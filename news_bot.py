import requests
import urllib.parse
import json
import os
from datetime import datetime

# 1. í™˜ê²½ë³€ìˆ˜ ì„¤ì •
SLACK_URL = os.environ['SLACK_WEBHOOK_URL']
NAVER_ID = os.environ['NAVER_CLIENT_ID']
NAVER_SECRET = os.environ['NAVER_CLIENT_SECRET']

# 2. ë‰´ìŠ¤ ê²€ìƒ‰ í•¨ìˆ˜
def get_news(keyword, count):
    enc_text = urllib.parse.quote(keyword)
    
    # ğŸ”´ ìˆ˜ì •ë¨: sort='date' (ìµœì‹ ìˆœ)ìœ¼ë¡œ ë³€ê²½!
    # ì´ì œ ë¬´ì¡°ê±´ ê°€ì¥ ìµœê·¼ì— ì˜¬ë¼ì˜¨ ê¸°ì‚¬ë¶€í„° ê°€ì ¸ì˜µë‹ˆë‹¤.
    url = f"https://openapi.naver.com/v1/search/news.json?query={enc_text}&display={count}&sort=date"
    
    headers = {
        "X-Naver-Client-Id": NAVER_ID,
        "X-Naver-Client-Secret": NAVER_SECRET
    }
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json().get('items', [])
        return []
    except:
        return []

# 3. ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
def send_alert():
    # ë‚ ì§œ ì„œì‹
    today = datetime.now().strftime("%Y. %m. %d. (%a)")
    
    # ğŸ¨ [ì„¤ì •] (ë³´ì—¬ì§ˆ ì œëª©, ì‹¤ì œ ê²€ìƒ‰ì–´, ê°€ì ¸ì˜¬ ê°œìˆ˜)
    search_configs = [
        ("ğŸš™ ì œì£¼ ë Œí„°ì¹´", "ì œì£¼ (ë Œí„°ì¹´ | ë ŒíŠ¸ì¹´)", 3),
        ("ğŸš• ì œì£¼ ëª¨ë¹Œë¦¬í‹°", "ì œì£¼ ëª¨ë¹Œë¦¬í‹°", 1),
        ("ğŸš™ ì˜ì¹´(SOCAR)", "ì œì£¼ ì˜ì¹´", 1),
        ("ğŸŒ´ ì œì£¼ ê´€ê´‘", "ì œì£¼ ê´€ê´‘", 3),
        ("âœˆï¸ ì œì£¼ ê³µí•­", "ì œì£¼ ê³µí•­", 1),
        ("ğŸŒ¤ï¸ ì œì£¼ ë‚ ì”¨", "ì œì£¼ ì˜ˆë³´", 1)
    ]
    
    # ğŸ§± [ë¸”ë¡ í‚·] ë©”ì‹œì§€ êµ¬ì„±
    blocks = []
    
    # (1) í—¤ë”
    blocks.append({
        "type": "header",
        "text": {
            "type": "plain_text",
            "text": f"ğŸ“… {today} ë‰´ìŠ¤ ë¸Œë¦¬í•‘",
            "emoji": True
        }
    })
    
    # (2) ì£¼ì œë³„ ë‰´ìŠ¤ ë¸”ë¡
    for display_title, keyword, count in search_configs:
        news_items = get_news(keyword, count)
        
        blocks.append({"type": "divider"})
        blocks.append({
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"*{display_title}*"
            }
        })
        
        if not news_items:
            blocks.append({
                "type": "context",
                "elements": [{"type": "mrkdwn", "text": "ğŸš« ê´€ë ¨ ìµœì‹  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."}]
            })
        else:
            news_text = ""
            for item in news_items:
                title = item['title'].replace('<b>', '').replace('</b>', '').replace('&quot;', "'")
                link = item['link']
                news_text += f"â€¢ <{link}|{title}>\n"
            
            blocks.append({
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": news_text
                }
            })

    # (3) í•˜ë‹¨ í‘¸í„°
    blocks.append({"type": "divider"})
    blocks.append({
        "type": "context",
        "elements": [
            {
                "type": "mrkdwn",
                "text": "ğŸ“¢ Generated by JejuBot | Data Source: Naver Search API"
            }
        ]
    })

    # ì „ì†¡
    payload = {
        "text": f"ğŸ“… {today} ì œì£¼ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.",
        "blocks": blocks
    }
    requests.post(SLACK_URL, data=json.dumps(payload))
    print("âœ… ì „ì†¡ ì™„ë£Œ")

if __name__ == "__main__":
    send_alert()
