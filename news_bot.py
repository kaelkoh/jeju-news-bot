import requests
import urllib.parse
import json
import os
from datetime import datetime

# 1. í™˜ê²½ë³€ìˆ˜ ì„¤ì •
SLACK_URL = os.environ['SLACK_WEBHOOK_URL']
NAVER_ID = os.environ['NAVER_CLIENT_ID']
NAVER_SECRET = os.environ['NAVER_CLIENT_SECRET']

# 2. ë‰´ìŠ¤ ê²€ìƒ‰ í•¨ìˆ˜
def get_news(keyword, count):
    enc_text = urllib.parse.quote(keyword)
    # sort='sim': ì •í™•ë„ìˆœ, display=count: ê°œìˆ˜
    url = f"https://openapi.naver.com/v1/search/news.json?query={enc_text}&display={count}&sort=sim"
    
    headers = {
        "X-Naver-Client-Id": NAVER_ID,
        "X-Naver-Client-Secret": NAVER_SECRET
    }
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json().get('items', [])
        return []
    except:
        return []

# 3. ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
def send_alert():
    # ë‚ ì§œ ì„œì‹ (ì˜ˆ: 2026. 02. 10. í™”ìš”ì¼)
    today = datetime.now().strftime("%Y. %m. %d. (%a)")
    
    # ğŸ¨ [ì„¤ì •] (ë³´ì—¬ì§ˆ ì œëª©, ì‹¤ì œ ê²€ìƒ‰ì–´, ê°€ì ¸ì˜¬ ê°œìˆ˜)
    search_configs = [
        ("ğŸš™ ì œì£¼ ë Œí„°ì¹´", "ì œì£¼ (ë Œí„°ì¹´ | ë ŒíŠ¸ì¹´)", 3),
        ("ğŸš• ì œì£¼ ëª¨ë¹Œë¦¬í‹°", "ì œì£¼ ëª¨ë¹Œë¦¬í‹°", 1),
        ("ğŸš™ ì˜ì¹´(SOCAR)", "ì œì£¼ ì˜ì¹´", 1),
        ("ğŸŒ´ ì œì£¼ ê´€ê´‘", "ì œì£¼ ê´€ê´‘", 3),
        ("âœˆï¸ ì œì£¼ ê³µí•­", "ì œì£¼ ê³µí•­", 1),
        ("ğŸŒ¤ï¸ ì œì£¼ ë‚ ì”¨", "ì œì£¼ ì˜ˆë³´", 1)
    ]
    
    # ğŸ§± [ë¸”ë¡ í‚·] ë©”ì‹œì§€ êµ¬ì„± ì‹œì‘
    blocks = []
    
    # (1) í—¤ë” (ê°€ì¥ í° ì œëª©)
    blocks.append({
        "type": "header",
        "text": {
            "type": "plain_text",
            "text": f"ğŸ“… {today} ë‰´ìŠ¤ ë¸Œë¦¬í•‘",
            "emoji": True
        }
    })
    
    # (2) ì£¼ì œë³„ ë‰´ìŠ¤ ë¸”ë¡ ì¶”ê°€
    for display_title, keyword, count in search_configs:
        news_items = get_news(keyword, count)
        
        # êµ¬ë¶„ì„  (ì£¼ì œë§ˆë‹¤ ìƒë‹¨ì— ë°°ì¹˜í•˜ì—¬ ê¹”ë”í•˜ê²Œ ë¶„ë¦¬)
        blocks.append({"type": "divider"})
        
        # ì£¼ì œ ì œëª© (ì§„í•˜ê²Œ)
        blocks.append({
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f"*{display_title}*"
            }
        })
        
        if not news_items:
            # ë‰´ìŠ¤ê°€ ì—†ì„ ë•Œ (ì‘ì€ íšŒìƒ‰ ê¸€ì”¨)
            blocks.append({
                "type": "context",
                "elements": [{"type": "mrkdwn", "text": "ğŸš« ê´€ë ¨ ìµœì‹  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."}]
            })
        else:
            # ë‰´ìŠ¤ê°€ ìˆì„ ë•Œ (ë¦¬ìŠ¤íŠ¸ í˜•íƒœ)
            news_text = ""
            for item in news_items:
                # ì œëª© ì •ì œ (ë”°ì˜´í‘œ ë° íƒœê·¸ ì œê±°)
                title = item['title'].replace('<b>', '').replace('</b>', '').replace('&quot;', "'")
                link = item['link']
                # â€¢ <ë§í¬|ì œëª©> í˜•íƒœë¡œ í´ë¦­ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ìƒì„±
                news_text += f"â€¢ <{link}|{title}>\n"
            
            # ë³¸ë¬¸ ì¶”ê°€
            blocks.append({
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": news_text
                }
            })

    # (3) í•˜ë‹¨ í‘¸í„° (ì¶œì²˜ í‘œì‹œ)
    blocks.append({"type": "divider"})
    blocks.append({
        "type": "context",
        "elements": [
            {
                "type": "mrkdwn",
                "text": "ğŸ“¢ Generated by JejuBot | Data Source: Naver Search API"
            }
        ]
    })

    # ğŸ“¨ ì „ì†¡ (blocks íŒŒë¼ë¯¸í„° ì‚¬ìš© - ì´ê²Œ í•µì‹¬!)
    payload = {
        "text": f"ğŸ“… {today} ì œì£¼ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.", # ì•Œë¦¼ íŒì—…ìš© í…ìŠ¤íŠ¸
        "blocks": blocks
    }
    requests.post(SLACK_URL, data=json.dumps(payload))
    print("âœ… ì „ì†¡ ì™„ë£Œ")

if __name__ == "__main__":
    send_alert()
